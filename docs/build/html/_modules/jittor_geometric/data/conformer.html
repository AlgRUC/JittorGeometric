

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jittor_geometric.data.conformer &mdash; Jittor_Geometric 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Jittor_Geometric
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Jittor Geometric</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install/installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/introduction.html">Get Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/nn.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/data.html">jittor_geometric.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets/datasets.html">jittor_geometric.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataloader/dataloader.html">jittor_geometric.dataloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/io.html">jittor_geometric.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../partition/partition.html">jittor_geometric.partition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transforms/transforms.html">jittor_geometric.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ops/ops.html">jittor_geometric.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils/utils.html">jittor_geometric.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Jittor_Geometric</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jittor_geometric.data.conformer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jittor_geometric.data.conformer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) DP Technology.</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance_matrix</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.dictionary</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="ConformerGen">
<a class="viewcode-back" href="../../../data/data.html#jittor_geometric.data.ConformerGen">[docs]</a>
<span class="k">class</span> <span class="nc">ConformerGen</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class designed to generate conformers for molecules represented as SMILES strings using provided parameters and configurations. The `transform` method uses multiprocessing to speed up the conformer generation process.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the neural network model based on the provided model name and parameters.</span>

<span class="sd">        :param model_name: (str) The name of the model to initialize.</span>
<span class="sd">        :param params: Additional parameters for model configuration.</span>

<span class="sd">        :return: An instance of the specified neural network model.</span>
<span class="sd">        :raises ValueError: If the model name is not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_features</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the features of the ConformerGen object based on provided parameters.</span>

<span class="sd">        :param params: Arbitrary keyword arguments for feature configuration.</span>
<span class="sd">                       These can include the random seed, maximum number of atoms, data type,</span>
<span class="sd">                       generation method, generation mode, and whether to remove hydrogens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_atoms</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_atoms&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="s1">&#39;molecule&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;rdkit_random&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;fast&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_hs</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_hs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">add_symbol</span><span class="p">(</span><span class="s2">&quot;[MASK]&quot;</span><span class="p">,</span> <span class="n">is_special</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ConformerGen.single_process">
<a class="viewcode-back" href="../../../data/data.html#jittor_geometric.data.ConformerGen.single_process">[docs]</a>
    <span class="k">def</span> <span class="nf">single_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes a single SMILES string to generate conformers using the specified method.</span>

<span class="sd">        :param smiles: (str) The SMILES string representing the molecule.</span>
<span class="sd">        :return: A unimolecular data representation (dictionary) of the molecule.</span>
<span class="sd">        :raises ValueError: If the conformer generation method is unrecognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rdkit_random&#39;</span><span class="p">:</span>
            <span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="n">inner_smi2coords</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_hs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coords2unimol</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_atoms</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_hs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown conformer generation method: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="ConformerGen.transform_raw">
<a class="viewcode-back" href="../../../data/data.html#jittor_geometric.data.ConformerGen.transform_raw">[docs]</a>
    <span class="k">def</span> <span class="nf">transform_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms_list</span><span class="p">,</span> <span class="n">coordinates_list</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atoms_list</span><span class="p">,</span> <span class="n">coordinates_list</span><span class="p">):</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords2unimol</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_atoms</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_hs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">inputs</span></div>


<div class="viewcode-block" id="ConformerGen.transform">
<a class="viewcode-back" href="../../../data/data.html#jittor_geometric.data.ConformerGen.transform">[docs]</a>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">):</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start generating conformers...&#39;</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">single_process</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">))]</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">failed_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_coord&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Succeed to generate conformers for </span><span class="si">{:.2f}% o</span><span class="s1">f molecules.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">failed_cnt</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
        <span class="n">failed_3d_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_coord&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Succeed to generate 3d conformers for </span><span class="si">{:.2f}% o</span><span class="s1">f molecules.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">failed_3d_cnt</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">inputs</span></div>
</div>



<span class="k">def</span> <span class="nf">inner_smi2coords</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function is responsible for converting a SMILES (Simplified Molecular Input Line Entry System) string into 3D coordinates for each atom in the molecule. It also allows for the generation of 2D coordinates if 3D conformation generation fails, and optionally removes hydrogen atoms and their coordinates from the resulting data.</span>

<span class="sd">    :param smi: (str) The SMILES representation of the molecule.</span>
<span class="sd">    :param seed: (int, optional) The random seed for conformation generation. Defaults to 42.</span>
<span class="sd">    :param mode: (str, optional) The mode of conformation generation, &#39;fast&#39; for quick generation, &#39;heavy&#39; for more attempts. Defaults to &#39;fast&#39;.</span>
<span class="sd">    :param remove_hs: (bool, optional) Whether to remove hydrogen atoms from the final coordinates. Defaults to True.</span>

<span class="sd">    :return: A tuple containing the list of atom symbols and their corresponding 3D coordinates.</span>
<span class="sd">    :raises AssertionError: If no atoms are present in the molecule or if the coordinates do not align with the atom count.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">())</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;No atoms in molecule: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># will random generate conformer with seed equal to -1. else fixed random seed.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">randomSeed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># some conformer can not use MMFF optimize</span>
                <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">GetPositions</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">GetPositions</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">## for fast test... ignore this ###</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;heavy&#39;</span><span class="p">:</span>
            <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">maxAttempts</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">randomSeed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># some conformer can not use MMFF optimize</span>
                <span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">GetPositions</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">coordinates_2d</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">GetPositions</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates_2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">coordinates_2d</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span><span class="o">.</span><span class="n">GetPositions</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates_2d</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to generate conformer, replace with zeros.&quot;</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="s2">&quot;coordinates shape is not align with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_hs</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="n">atoms_no_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="n">coordinates_no_h</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_no_h</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates_no_h</span><span class="p">),</span> <span class="s2">&quot;coordinates shape is not align with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atoms_no_h</span><span class="p">,</span> <span class="n">coordinates_no_h</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span>

<span class="k">def</span> <span class="nf">inner_coords</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a list of atoms and their corresponding coordinates to remove hydrogen atoms if specified.</span>
<span class="sd">    This function takes a list of atom symbols and their corresponding coordinates and optionally removes hydrogen atoms from the output. It includes assertions to ensure the integrity of the data and uses numpy for efficient processing of the coordinates. </span>

<span class="sd">    :param atoms: (list) A list of atom symbols (e.g., [&#39;C&#39;, &#39;H&#39;, &#39;O&#39;]).</span>
<span class="sd">    :param coordinates: (list of tuples or list of lists) Coordinates corresponding to each atom in the `atoms` list.</span>
<span class="sd">    :param remove_hs: (bool, optional) A flag to indicate whether hydrogen atoms should be removed from the output.</span>
<span class="sd">                      Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    :return: A tuple containing two elements; the filtered list of atom symbols and their corresponding coordinates.</span>
<span class="sd">             If `remove_hs` is False, the original lists are returned.</span>
<span class="sd">    </span>
<span class="sd">    :raises AssertionError: If the length of `atoms` list does not match the length of `coordinates` list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="s2">&quot;coordinates shape is not align atoms&quot;</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_hs</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="n">atoms_no_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="n">coordinates_no_h</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_no_h</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates_no_h</span><span class="p">),</span> <span class="s2">&quot;coordinates shape is not align with atoms&quot;</span>
        <span class="k">return</span> <span class="n">atoms_no_h</span><span class="p">,</span> <span class="n">coordinates_no_h</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span>

<span class="k">def</span> <span class="nf">coords2unimol</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts atom symbols and coordinates into a unified molecular representation.</span>

<span class="sd">    :param atoms: (list) List of atom symbols.</span>
<span class="sd">    :param coordinates: (ndarray) Array of atomic coordinates.</span>
<span class="sd">    :param dictionary: (Dictionary) An object that maps atom symbols to unique integers.</span>
<span class="sd">    :param max_atoms: (int) The maximum number of atoms to consider for the molecule.</span>
<span class="sd">    :param remove_hs: (bool) Whether to remove hydrogen atoms from the representation.</span>
<span class="sd">    :param params: Additional parameters.</span>

<span class="sd">    :return: A dictionary containing the molecular representation with tokens, distances, coordinates, and edge types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="n">inner_coords</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="n">remove_hs</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># cropping atoms and coordinates</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_atoms</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="n">max_atoms</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c1"># tokens padding</span>
    <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dictionary</span><span class="o">.</span><span class="n">bos</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">eos</span><span class="p">()])</span>
    <span class="n">src_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)))</span>
    <span class="c1"># coordinates normalize &amp; padding</span>
    <span class="n">src_coord</span> <span class="o">=</span> <span class="n">coordinates</span> <span class="o">-</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">src_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">src_coord</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># distance matrix</span>
    <span class="n">src_distance</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="n">src_coord</span><span class="p">,</span> <span class="n">src_coord</span><span class="p">)</span>
    <span class="c1"># edge type</span>
    <span class="n">src_edge_type</span> <span class="o">=</span> <span class="n">src_tokens</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span> <span class="o">+</span> <span class="n">src_tokens</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;src_tokens&#39;</span><span class="p">:</span> <span class="n">src_tokens</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> 
            <span class="s1">&#39;src_distance&#39;</span><span class="p">:</span> <span class="n">src_distance</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
            <span class="s1">&#39;src_coord&#39;</span><span class="p">:</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
            <span class="s1">&#39;src_edge_type&#39;</span><span class="p">:</span> <span class="n">src_edge_type</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Jittor_Geometric_Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>